<!DOCTYPE html>
<html lang="en-us" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.124.1">
    <meta name="generator" content="Relearn 5.26.2+tip">
    <meta name="description" content="Linux, Tech, Open Source Software, Privacy">
    <meta name="author" content="David">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Hosting Your Own Email Server - Perfect Dark Mode">
    <meta name="twitter:description" content="Make sure your VSP unblocks port 25
Allow ports using your firewall
ufw allow 25/tcp ufw allow 587/tcpInstall mailutils
apt install -y mailutils postfixSelect &ldquo;internet site&rdquo; in the gui.
Then enter your domain name &ldquo;example.com&rdquo;
(Screenshot)
Reverse DNS (rDNS) Email servers may require a PTR record to prevent spam
In vultr (VPS) make sure your reverse DNS is set to your domain name. Do this for both ipv4 and ipv6 under settings.">
    <meta property="og:title" content="Hosting Your Own Email Server - Perfect Dark Mode">
    <meta property="og:description" content="Make sure your VSP unblocks port 25
Allow ports using your firewall
ufw allow 25/tcp ufw allow 587/tcpInstall mailutils
apt install -y mailutils postfixSelect &ldquo;internet site&rdquo; in the gui.
Then enter your domain name &ldquo;example.com&rdquo;
(Screenshot)
Reverse DNS (rDNS) Email servers may require a PTR record to prevent spam
In vultr (VPS) make sure your reverse DNS is set to your domain name. Do this for both ipv4 and ipv6 under settings.">
    <meta property="og:type" content="article">
    <meta property="og:url" content="http://perfectdarkmode.com/tools/emailserver/">
    <meta property="article:section" content="Tools - Perfect Dark Mode">
    <meta property="og:site_name" content="Perfect Dark Mode">
    <title>Hosting Your Own Email Server - Perfect Dark Mode</title>
    <link href="http://perfectdarkmode.com/tools/emailserver/" rel="canonical" type="text/html" title="Hosting Your Own Email Server - Perfect Dark Mode">
    <link href="/tools/emailserver/index.xml" rel="alternate" type="application/rss+xml" title="Hosting Your Own Email Server - Perfect Dark Mode">
    <link href="/images/favicon.png?1711972775" rel="icon" type="image/png">
    <!-- https://github.com/filamentgroup/loadCSS/blob/master/README.md#how-to-use -->
    <link href="/css/fontawesome-all.min.css?1711972776" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="/css/fontawesome-all.min.css?1711972776" rel="stylesheet"></noscript>
    <link href="/css/nucleus.css?1711972776" rel="stylesheet">
    <link href="/css/auto-complete.css?1711972776" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="/css/auto-complete.css?1711972776" rel="stylesheet"></noscript>
    <link href="/css/perfect-scrollbar.min.css?1711972776" rel="stylesheet">
    <link href="/css/fonts.css?1711972776" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="/css/fonts.css?1711972776" rel="stylesheet"></noscript>
    <link href="/css/theme.css?1711972776" rel="stylesheet">
    <link href="/css/theme-git.css?1711972776" rel="stylesheet" id="R-variant-style">
    <link href="/css/chroma-relearn-dark.css?1711972776" rel="stylesheet" id="R-variant-chroma-style">
    <link href="/css/variant.css?1711972776" rel="stylesheet">
    <link href="/css/print.css?1711972776" rel="stylesheet" media="print">
    <link href="/css/format-print.css?1711972776" rel="stylesheet">
    <link href="/css/ie.css?1711972776" rel="stylesheet">
    <script src="/js/url.js?1711972776"></script>
    <script src="/js/variant.js?1711972776"></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.relBasePath='..\/..';
      window.relearn.relBaseUri='..\/..';
      window.relearn.absBaseUri='http:\/\/perfectdarkmode.com';
      window.index_js_url="/index.search.js";
      // variant stuff
      window.relearn.themeVariantModifier='';
      window.variants && variants.init( [ 'git' ] );
      // translations
      window.T_Copy_to_clipboard = `Copy to clipboard`;
      window.T_Copied_to_clipboard = `Copied to clipboard!`;
      window.T_Copy_link_to_clipboard = `Copy link to clipboard`;
      window.T_Link_copied_to_clipboard = `Copied link to clipboard!`;
      window.T_Reset_view = `Reset view`;
      window.T_View_reset = `View reset!`;
      window.T_No_results_found = `No results found for "{0}"`;
      window.T_N_results_found = `{1} results found for "{0}"`;
    </script>
  </head>
  <body class="mobile-support print" data-url="/tools/emailserver/">
    <div id="R-body" class="default-animation">
      <div id="R-body-overlay"></div>
      <nav id="R-topbar">
        <div class="topbar-wrapper">
          <div class="topbar-sidebar-divider"></div>
          <div class="topbar-area topbar-area-start" data-area="start">
            <div class="topbar-button topbar-button-sidebar" data-content-empty="disable" data-width-s="show" data-width-m="hide" data-width-l="hide"><button class="topbar-control" onclick="toggleNav()" type="button" title="Menu (CTRL&#43;ALT&#43;n)"><i class="fa-fw fas fa-bars"></i></button>
            </div>
            <div class="topbar-button topbar-button-back" data-content-empty="show" data-width-s="show" data-width-m="show" data-width-l="show"><button class="topbar-control" onclick="history.back()" type="button" title=""><i class="fa-fw fas fa-chevron-left"></i></button>
            </div>



          </div>
          <span class="topbar-breadcrumbs highlightable">
            Hosting Your Own Email Server
          </span>
          <div class="topbar-area topbar-area-end" data-area="end">
            <div class="topbar-button topbar-button-about" data-content-empty="show" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="https://perfectdarkmode.com/about/" target="_blank" title=""><i class="fa-fw fas fa-address-card"></i> <span class="title">About</span></a>
            </div>
            <div class="topbar-button topbar-button-now" data-content-empty="show" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="https://perfectdarkmode.com/now/" target="_blank" title=""><i class="fa-fw fas fa-play"></i> <span class="title">Now</span></a>
            </div>
            <div class="topbar-button topbar-button-recommended" data-content-empty="show" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="https://perfectdarkmode.com/recommended/" target="_blank" title=""><i class="fa-fw fas fa-thumbs-up"></i> <span class="title">Recommended</span></a>
            </div>
            <div class="topbar-button topbar-button-booknotes" data-content-empty="show" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="https://perfectdarkmode.com/booknotes/" target="_blank" title=""><i class="fa-fw fas fa-file"></i> <span class="title">Book Notes</span></a>
            </div>
            <div class="topbar-button topbar-button-contact" data-content-empty="show" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="https://perfectdarkmode.com/contact/" target="_blank" title=""><i class="fa-fw fas fa-envelope"></i> <span class="title">Contact</span></a>
            </div>






          </div>
        </div>
      </nav>
      <div id="R-main-overlay"></div>
      <main id="R-body-inner" class="highlightable default" tabindex="-1">
        <div class="flex-block-wrapper">
          <article class="default">
            <header class="headline">
            </header>
<h1 id="hosting-your-own-email-server">Hosting Your Own Email Server</h1>

<p>Make sure your VSP unblocks port 25</p>
<p>Allow ports using your firewall</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ufw allow 25/tcp
</span></span><span style="display:flex;"><span>ufw allow 587/tcp</span></span></code></pre></div><p>Install mailutils</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>apt install -y mailutils postfix</span></span></code></pre></div><p>Select &ldquo;internet site&rdquo; in the gui.</p>
<p>Then enter your domain name &ldquo;example.com&rdquo;</p>
<p>(Screenshot)</p>
<h2 id="reverse-dns-rdns">Reverse DNS (rDNS)</h2>
<p>Email servers may require a PTR record to prevent spam</p>
<p>In vultr (VPS) make sure your reverse DNS is set to your domain name. Do this for both ipv4 and ipv6 under settings.</p>
<h2 id="dkim-domain-keys-identified-mail">DKIM (Domain Keys Identified Mail)</h2>
<p>Used to prevent people from changing their from address.</p>
<p>Open DKIM is a tool that creates cryptographic public and private keys for your server. This way yopu emails can be trusted. Other servers can check your public key to make sure you are really you.</p>
<p>You will also need server-side authorization settings to verify which account the email came from.</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>apt install opendkim opendkim-tools</span></span></code></pre></div><p>Generate DKIM Key, create directory, and edit permissions.</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>mkdir -p /etc/postfix/dkim
</span></span><span style="display:flex;"><span>opendkim-genkey -D /etc/postfix/dkim/ -d example.org -s mail
</span></span><span style="display:flex;"><span>chgrp opendkim /etc/postfix/dkim/*
</span></span><span style="display:flex;"><span>chmod g+r /etc/postfix/dkim/*</span></span></code></pre></div><p>Create the key table</p>
<p>tell OpenDKIM where the keys are</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ff5c57">echo</span> <span style="color:#5af78e">&#34;mail._domainkey.example.org example.org:mail:/etc/postfix/dkim/mail.private&#34;</span> &gt; /etc/postfix/dkim/keytable</span></span></code></pre></div><p>Create signing table</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ff5c57">echo</span> <span style="color:#5af78e">&#34;*@example.org mail._domainkey.example.org&#34;</span> &gt; /etc/postfix/dkim/signingtable</span></span></code></pre></div><p>Add trusted hosts</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ff5c57">echo</span> <span style="color:#5af78e">&#34;127.0.0.1
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">10.1.0.0/16
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">1.2.3.4/24&#34;</span> &gt; /etc/postfix/dkim/trustedhosts</span></span></code></pre></div><p>OpenDKIM configuration file</p>
<p>open up <code>/etc/opendkim.conf</code>
add these lines to source the files created above</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>KeyTable file:/etc/postfix/dkim/keytable
</span></span><span style="display:flex;"><span>SigningTable refile:/etc/postfix/dkim/signingtable
</span></span><span style="display:flex;"><span>InternalHosts refile:/etc/postfix/dkim/trustedhosts
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Canonicalization        relaxed/simple
</span></span><span style="display:flex;"><span>Socket                  inet:12301@localhost</span></span></code></pre></div><p>the socket option will already be set in the configuration file. COmment it out or overwrite this.</p>
<h2 id="allowing-postfix-to-interface-with-opendkim">Allowing postfix to interface with OPenDKIM</h2>
<p>set our OpenDKIM server, which will be running on port <code>12301</code>, as a milter (mail filter).</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>postconf -e <span style="color:#5af78e">&#34;myhostname = </span><span style="color:#ff6ac1">$(</span>cat /etc/mailname<span style="color:#ff6ac1">)</span><span style="color:#5af78e">&#34;</span>
</span></span><span style="display:flex;"><span>postconf -e <span style="color:#5af78e">&#34;milter_default_action = accept&#34;</span>
</span></span><span style="display:flex;"><span>postconf -e <span style="color:#5af78e">&#34;milter_protocol = 6&#34;</span>
</span></span><span style="display:flex;"><span>postconf -e <span style="color:#5af78e">&#34;smtpd_milters = inet:localhost:12301&#34;</span>
</span></span><span style="display:flex;"><span>postconf -e <span style="color:#5af78e">&#34;non_smtpd_milters = inet:localhost:12301&#34;</span></span></span></code></pre></div><p>Restart and reload the services</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>systemctl restart opendkim
</span></span><span style="display:flex;"><span>systemctl <span style="color:#ff5c57">enable</span> opendkim
</span></span><span style="display:flex;"><span>systemctl reload postfix</span></span></code></pre></div><h2 id="add-key-as-txt-record-in-your-registrar">Add key as TXT record in your registrar</h2>
<p>Grab the key</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ff5c57">echo</span> -e <span style="color:#5af78e">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">v=DKIM1; k=rsa; </span><span style="color:#ff6ac1">$(</span>tr -d <span style="color:#5af78e">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">&#34;</span> &lt;/etc/postfix/dkim/mail.txt | sed <span style="color:#5af78e">&#34;s/k=rsa.* \&#34;p=/k=rsa; p=/;s/\&#34;\s*\&#34;//;s/\&#34;\s*).*//&#34;</span> | grep -o <span style="color:#5af78e">&#34;p=.*&#34;</span><span style="color:#ff6ac1">)</span><span style="color:#5af78e">
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">&#34;</span></span></span></code></pre></div><p>Grab the key that starts with v=DKIM1 and enter it as the TXT Value for the record.</p>
<p>enter the host name:
mail._domainkey</p>
<p>Test</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ff5c57">echo</span> <span style="color:#5af78e">&#34;Hi there.
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">This is the text.&#34;</span> | mail -s <span style="color:#5af78e">&#34;Email from the server&#34;</span> your@emailaddress.com</span></span></code></pre></div><p>For more help <a href="https://appmaildev.com/en/dkim" target="_blank">https://appmaildev.com/en/dkim</a></p>
<h2 id="dmarc-domain-based-message-authentication-protocol">DMARC (Domain-based Message Authentication Protocol)</h2>
<p>Give email domain owners the ability to protect your domain from unauthorized use.</p>
<p>Add the dmarc user:</p>
<div class="highlight wrap-code"><pre tabindex="0"><code>useradd -m -G mail dmarc</code></pre></div><p>make a new TXT record like we did with DKIM, except now use the output from the following command:</p>
<div class="highlight wrap-code"><pre tabindex="0"><code>echo &#34;_dmarc.$(cat /etc/mailname)&#34;
echo &#34;v=DMARC1; p=reject; rua=mailto:dmarc@$(cat /etc/mailname); fo=1&#34;</code></pre></div><p>The first line is the Host field. The latter is the TXT value.</p>
<h3 id="sender-policy-framework">Sender Policy Framework</h3>
<p>Saving the easiest for last, we should add a TXT record for SPF, an email-authentication standard used to prevent spammers from sending messages that appear to come from a spoofed domain.</p>
<div class="highlight wrap-code"><pre tabindex="0"><code>cat /etc/mailname
echo &#34;v=spf1 mx a:mail.$(cat /etc/mailname) -all&#34;</code></pre></div><p>The output of <code>cat /etc/mailname</code> is the Host field. The output of the second command is the TXT value.</p>
<p>Again, you can check <a href="https://appmaildev.com/en/spf" target="_blank">that site</a> to make sure your DKIM, DMARC, and SPF entries are valid. That’s it!</p>
<h1 id="setting-up-an-e-mail-inbox">Setting up an E-mail Inbox</h1>
<p>In the article on <a href="https://landchad.net/mail/smtp" target="_blank">SMTP and Postfix</a>, we set up a simple Postfix server that we could use to programatically send mail with the <code>mail</code> command. In order to have a true and fully-functional mail server, users should be able to login to a mail client where they can read their inbox and send mail remotely. In order to achieve this we need Dovecot, which can store mails received by the server, authenticate user accounts and interact with mail.</p>
<p>If we’re setting up an inbox we will also want spam detection software, such as spam assassin.</p>
<h2 id="dovecot-and-spamassassin">Dovecot and Spamassassin</h2>
<div class="highlight wrap-code"><pre tabindex="0"><code>apt install dovecot-imapd dovecot-sieve spamassassin spamc</code></pre></div><p>Unblock the imap port:</p>
<div class="highlight wrap-code"><pre tabindex="0"><code>ufw allow 993</code></pre></div><h2 id="certificate">Certificate</h2>
<p>We will want a SSL certificate for the <code>mail.</code> subdomain. We can get this with <a href="https://landchad.net/basic/certbot/" target="_blank">Certbot</a>. Assuming we are using Nginx for our server otherwise, run:</p>
<div class="highlight wrap-code"><pre tabindex="0"><code>certbot --nginx certonly -d mail.example.org</code></pre></div><h2 id="dns">DNS</h2>
<p>We also need two little DNS records set on your domain registrar’s site/DNS server:</p>
<ol>
<li>An MX record. Just put your domain, <strong>example.org</strong>, in the “Points to” field.</li>
<li>A CNAME record. Host field: <strong>mail.example.org</strong>. “Points to” field: <strong>example.org.</strong></li>
</ol>
<h2 id="configuring-dovecot">Configuring Dovecot</h2>
<p>Dovecot&rsquo;s configuration file is in <code>/etc/dovecot/docevot.conf</code>. If you open that file, you will see this line: <code>!include conf.d/*.conf</code> which adds all the <code>.conf</code> files in <code>/etc/dovecot/conf.d/</code> to the Dovecot configuration.</p>
<p>One can edit each of these files individually to get the needed configuration, but to make things easy here, delete or backup the main configuration file and we will replace it with one single config file with all important settings in it. Make sure you change <code>ssl_cert</code> and <code>ssl_key</code> accordingly.</p>
<div class="highlight wrap-code"><pre tabindex="0"><code class="language-wide" data-lang="wide"># Note that in the dovecot conf, you can use:
# %u for username
# %n for the name in name@domain.tld
# %d for the domain
# %h the user&#39;s home directory

# Connections between the mail client and Dovecot needs to be encrypted
ssl = required
ssl_cert = &lt;/etc/letsencrypt/live/mail.example.org/fullchain.pem
ssl_key = &lt;/etc/letsencrypt/live/mail.example.org/privkey.pem
ssl_min_protocol = TLSv1.2
ssl_cipher_list = EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA256:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384:EDH+aRSA+AESGCM:EDH+aRSA+SHA256:EDH+aRSA:EECDH:!aNULL:!eNULL:!MEDIUM:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS:!RC4:!SEED
ssl_prefer_server_ciphers = yes
ssl_dh = &lt;/usr/share/dovecot/dh.pem
auth_mechanisms = plain login
auth_username_format = %n

protocols = $protocols imap

# Search for valid users in /etc/passwd
userdb {
    driver = passwd
}
#Fallback: Use plain old PAM to find user passwords
passdb {
    driver = pam
}

# Our mail for each user will be in ~/Mail, and the inbox will be ~/Mail/Inbox
mail_location = maildir:~/Mail:INBOX=~/Mail/Inbox:LAYOUT=fs
namespace inbox {
    inbox = yes
    mailbox Drafts {
    special_use = \Drafts
    auto = subscribe
}
    mailbox Junk {
    special_use = \Junk
    auto = subscribe
    autoexpunge = 30d
}
    mailbox Sent {
    special_use = \Sent
    auto = subscribe
}
    mailbox Trash {
    special_use = \Trash
}
    mailbox Archive {
    special_use = \Archive
}
}

# Here we let Postfix use Dovecot&#39;s authetication system.
service auth {
  unix_listener /var/spool/postfix/private/auth {
    mode = 0660
    user = postfix
    group = postfix
}
}

protocol lda {
  mail_plugins = \$mail_plugins sieve
}
protocol lmtp {
  mail_plugins = \$mail_plugins sieve
}
plugin {
	sieve = ~/.dovecot.sieve
	sieve_default = /var/lib/dovecot/sieve/default.sieve
	sieve_dir = ~/.sieve
	sieve_global_dir = /var/lib/dovecot/sieve/
}</code></pre></div><h3 id="settings-explained">Settings Explained</h3>
<p>Take a good look at the above settings to understand what&rsquo;s going on. Some of the settings include:</p>
<ol>
<li>SSL settings to allow encrypted connections.</li>
<li>The mail server will authenticate users against PAM/passwd, which means users you create on the server (so long as they are part of the <code>mail</code> group) will be able to receive and send mail.</li>
<li>Default directories for a mail account: Inbox, Sent, Drafts, Junk, Trash and Archive.</li>
<li>Create a <code>unix_listener</code> that will allow Postfix to authenticate users via Dovecot.</li>
<li>Setup the Dovecot sieve plugin, which provides mail filtering facilities at time of final message delivery. Sieve scripts can be used to customize how messages are delivered, whether they’re forwarded or stored in special folders.</li>
</ol>
<p>Next, we can tell sieve to automatically move mail flagged as spam to the junk folder:</p>
<div class="highlight wrap-code"><pre tabindex="0"><code>echo &#34;require [\&#34;fileinto\&#34;, \&#34;mailbox\&#34;];
if header :contains \&#34;X-Spam-Flag\&#34; \&#34;YES\&#34;
        {
                fileinto \&#34;Junk\&#34;;
        }&#34; &gt; /var/lib/dovecot/sieve/default.sieve</code></pre></div><p>After that, we should create the <code>vmail</code> user and group, which will access the mails, and then update the sieve configuration:</p>
<div class="highlight wrap-code"><pre tabindex="0"><code>grep -q &#39;^vmail:&#39; /etc/passwd || useradd vmail
chown -R vmail:vmail /var/lib/dovecot
sievec /var/lib/dovecot/sieve/default.sieve</code></pre></div><p>Then, enable pam authentication for Dovecot:</p>
<div class="highlight wrap-code"><pre tabindex="0"><code>echo &#34;auth    required        pam_unix.so nullok
account required        pam_unix.so&#34; &gt;&gt; /etc/pam.d/dovecot</code></pre></div><h2 id="connecting-postfix-and-dovecot">Connecting Postfix and Dovecot</h2>
<p>We need to tell Postfix to look to Dovecot for authenticating users/passwords. Dovecot will be putting an authentication socket in <code>/var/spool/postfix/private/auth</code>.</p>
<div class="highlight wrap-code"><pre tabindex="0"><code>postconf -e &#39;smtpd_sasl_auth_enable = yes&#39;
postconf -e &#39;smtpd_sasl_type = dovecot&#39;
postconf -e &#39;smtpd_sasl_path = private/auth&#39;
postconf -e &#39;mailbox_command = /usr/lib/dovecot/deliver&#39;</code></pre></div><h2 id="connecting-postfix-and-spamassassin">Connecting Postfix and Spamassassin</h2>
<p>We will change <code>/etc/postifx/master.cf</code> so postfix can route mail through spamassassin. First we can cleanup the default configuration. Feel free to make a backup.</p>
<div class="highlight wrap-code"><pre tabindex="0"><code>sed -i &#39;/^\s*-o/d;/^\s*submission/d;/^\s*smtp/d&#39; /etc/postfix/master.cf</code></pre></div><p>Finally, run this command to finish the configuration for spamassassin.</p>
<div class="highlight wrap-code"><pre tabindex="0"><code>echo &#34;smtp unix - - n - - smtp
smtp inet n - y - - smtpd
  -o content_filter=spamassassin
submission inet n       -       y       -       -       smtpd
  -o syslog_name=postfix/submission
  -o smtpd_tls_security_level=encrypt
  -o smtpd_sasl_auth_enable=yes
  -o smtpd_tls_auth_only=yes
smtps     inet  n       -       y       -       -       smtpd
  -o syslog_name=postfix/smtps
  -o smtpd_tls_wrappermode=yes
  -o smtpd_sasl_auth_enable=yes
spamassassin unix -     n       n       -       -       pipe
  user=debian-spamd argv=/usr/bin/spamc -f -e /usr/sbin/sendmail -oi -f \${sender} \${recipient}&#34; &gt;&gt; /etc/postfix/master.cf</code></pre></div><h2 id="make-new-mail-accounts">Make new mail accounts</h2>
<p>This is the easy part. Let’s say we want to add a user Billy and let him receive mail, run this:</p>
<div class="highlight wrap-code"><pre tabindex="0"><code>useradd -m -G mail billy
passwd billy</code></pre></div><p>Any user added to the <code>mail</code> group will be able to receive mail. Suppose a user Cassie already exists and we want to let her receive mail too. Just run:</p>
<div class="highlight wrap-code"><pre tabindex="0"><code>usermod -a -G mail cassie</code></pre></div><h1 id="harden-your-e-mail-server">Harden your E-mail Server</h1>
<h2 id="hardening-postfix">Hardening Postfix</h2>
<p>Put restrictions on servers sending mail to you.</p>
<div class="highlight wrap-code"><pre tabindex="0"><code>postconf -e &#39;smtpd_recipient_restrictions = permit_sasl_authenticated, permit_mynetworks, reject_unauth_destination, reject_unknown_recipient_domain&#39;</code></pre></div><h2 id="anonymize-headers">Anonymize Headers</h2>
<p>Use some regular expressions to prevent some meta data like a client’s ip address from being leaked.</p>
<div class="highlight wrap-code"><pre tabindex="0"><code>echo &#34;/^Received:.*/     IGNORE
/^X-Originating-IP:/    IGNORE
/^User-Agent:/        IGNORE
/^X-Mailer:/        IGNORE&#34; &gt;&gt; /etc/postfix/header_checks</code></pre></div><p>Add this file to the postfix configuration:</p>
<div class="highlight wrap-code"><pre tabindex="0"><code>postconf -e &#34;header_checks = regexp:/etc/postfix/header_checks&#34;</code></pre></div><h2 id="fail2ban">Fail2Ban</h2>
<p>If you’re not familiar with fail2Ban, it’s essentially a program which blocks bot’s and hacker’s login requests after a few invalid attempts.</p>
<div class="highlight wrap-code"><pre tabindex="0"><code>apt-get install fail2ban</code></pre></div><p>Make a local copy of the configuration file:</p>
<div class="highlight wrap-code"><pre tabindex="0"><code>cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local</code></pre></div><p>Go down to the <code># Mail servers</code> line and paste this:</p>
<div class="highlight wrap-code"><pre tabindex="0"><code>[postfix]

enabled  = true
port     = smtp,ssmtp,submission
filter   = postfix
logpath  = /var/log/mail.log


[sasl]

enabled  = true
port     = smtp,ssmtp,submission,imap2,imap3,imaps,pop3,pop3s
filter   = postfix-sasl
# You might consider monitoring /var/log/mail.warn instead if you are
# running postfix since it would provide the same log lines at the
# &#34;warn&#34; level but overall at the smaller filesize.
logpath  = /var/log/mail.warn
maxretry = 1
bantime  = 21600

[dovecot]

enabled = true
port    = smtp,ssmtp,submission,imap2,imap3,imaps,pop3,pop3s
filter  = dovecot
logpath = /var/log/mail.log</code></pre></div><p>This will only grant 2 login attempts and then block the requester for 6 hours. Now restart <code>fail2ban</code>:</p>
<div class="highlight wrap-code"><pre tabindex="0"><code>systemctl restart fail2ban</code></pre></div>
            <footer class="footline">
            </footer>
          </article>

        </div>
      </main>
    </div>
    <script src="/js/clipboard.min.js?1711972776" defer></script>
    <script src="/js/perfect-scrollbar.min.js?1711972776" defer></script>
    <script>
      function useMathJax( config ){
        if( !Object.assign ){
          
          return;
        }
        window.MathJax = Object.assign( window.MathJax || {}, {
          loader: {
            load: ['[tex]/mhchem']
          },
          startup: {
            elements: [
              '.math'
            ]
          },
          tex: {
            inlineMath: [
              ['$', '$'], 
              ['\\(', '\\)']
            ]
          },
          options: {
            enableMenu: false 
          }
        }, config );
      }
      useMathJax( JSON.parse("{}") );
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="/js/d3/d3-color.min.js?1711972776" defer></script>
    <script src="/js/d3/d3-dispatch.min.js?1711972776" defer></script>
    <script src="/js/d3/d3-drag.min.js?1711972776" defer></script>
    <script src="/js/d3/d3-ease.min.js?1711972776" defer></script>
    <script src="/js/d3/d3-interpolate.min.js?1711972776" defer></script>
    <script src="/js/d3/d3-selection.min.js?1711972776" defer></script>
    <script src="/js/d3/d3-timer.min.js?1711972776" defer></script>
    <script src="/js/d3/d3-transition.min.js?1711972776" defer></script>
    <script src="/js/d3/d3-zoom.min.js?1711972776" defer></script>
    <script src="/js/js-yaml.min.js?1711972776" defer></script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js" defer></script>
    <script>
      window.themeUseMermaid = JSON.parse("{ \"theme\": \"default\" }");
    </script>
    <script src="/js/theme.js?1711972776" defer></script>
  </body>
</html>
